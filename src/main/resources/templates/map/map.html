<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>맵</title>
<style>
	html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        
</style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9bb092e55e04073df199c8fdf46abadd"></script>
	
	<script th:inline="javascript">
	let map;
	let markers = [];
	let polylines = [];
	let bounds;
	let currentLatitude;
	let currentLongitude;
	let selectLatitude;
	let selectLongitude;
	let paths = [];
	
	$(document).ready(function() {
		let mapContainer = document.getElementById('map'), // 지도를 표시할 div 
		mapOption = {
			center : new kakao.maps.LatLng(37.499396, 127.029038), // 지도의 중심좌표
			level : 5 // 지도의 확대 레벨
		};

		map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성
		
		getCurrentLocation().done(function(position) {
			currentLatitude = position.coords.latitude;
			currentLongitude = position.coords.longitude;
			
			setMarkers([{ latitude: currentLatitude, longitude: currentLongitude }]);

			const requestData = { latitude: currentLatitude, longitude: currentLongitude, radius: 5 };

			$.ajax({
				url: "http://localhost:8000/map/rest/test", // 요청을 보낼 URL을 입력
				contentType: 'application/json', // Content-Type을 JSON으로 설정
				method: 'POST',
				data: JSON.stringify(requestData),
				success: function(response) {
					console.log(response);

					const coordinates = response.map(record => ({
						latitude: record.latitude,
						longitude: record.longitude
					}));

					setMarkers(coordinates);
				}, // success
				error: function(error) {
					console.log('ajax 에러 발생:', error);
				} // error
			}); // 페이지가 로드되면 AJAX 요청 보내기
		}).fail(function(error) {
			console.log('위치 정보를 불러오는데 실패함:', error);
		});
	}); // onload시 실행
	
	const drawRoute = (type) => {
		const urlParameter = type == 1 ? "getPedestrianRoute" : "getCarRoute";
	    clearMarkers();
	    clearPolylines();
	    
	    getCurrentLocation().done(function(position) {
	        currentLatitude = position.coords.latitude;
	        currentLongitude = position.coords.longitude;

	        let tDescription; // 설명
	        let drawInfoArr = []; // 선을 그릴 위도,경도 모음

	        const requestData = {
	            startX: currentLongitude,
	            startY: currentLatitude,
	            endX: selectLongitude,
	            endY: selectLatitude,
	            reqCoordType: "WGS84GEO",
	            resCoordType: "WGS84GEO",
	            startName: "출발",
	            endName: "도착"
	        }; // 보행자, 자동차

	        $.ajax({
	            method: "POST",
	            contentType: 'application/json; charset=utf-8',
	            url: "http://localhost:8000/map/rest/" + urlParameter,
	            data: JSON.stringify(requestData),

	            success: function(response) {
	                console.log(response);

	                setMarkers([
	                    { latitude: requestData.startY, longitude: requestData.startX },
	                    { latitude: requestData.endY, longitude: requestData.endX }
	                ]);

	                const tDistance = "<span>총 거리 : " + ((response.totalDistance) / 1000).toFixed(1) + "km,</span>";
	                const tTime = "<span>총 시간 : " + ((response.totalTime) / 60).toFixed(0) + "분</span>";

	                $("#result").html(tDistance + tTime);

	                bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경

	                for (let i = 0; i < response.lat.length; i++) {
	                    const latlng = new kakao.maps.LatLng(response.lat[i], response.lon[i]);
	                    bounds.extend(latlng);
	                    drawInfoArr.push(latlng);
	                }

	                let description = $('#description');
	                description.empty();
	                response.description.forEach(function(desc) {
	                    let p = $('<p></p>').text(desc);
	                    description.append(p);
	                });

	                drawLine(drawInfoArr, 1);
	                map.setBounds(bounds);
	            }, // success

	            error: function(request, status, error) {
	                console.error("에러!!");
	            } // error
	        }); // ajax
	    }).fail(function(error) {
	        console.log('Error getting location:', error);
	    });
	}; // 도보 경로찾기

	const drawTransitRoute = () => {
	    clearMarkers();
	    clearPolylines();
	    getCurrentLocation().done(function(position) {
	        currentLatitude = position.coords.latitude;
	        currentLongitude = position.coords.longitude;

	        let tDescription; // 설명
	        let drawInfoArr = []; // 선을 그릴 위도,경도 모음
	        bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경

	        console.log(currentLongitude);
	        console.log(currentLatitude);

	        const requestData = {
	            startX: currentLongitude,
	            startY: currentLatitude,
	            endX: selectLongitude,
	            endY: selectLatitude,
	            lang: "0",
	            count: "10",
	            format: "json"
	        }; // 대중교통

	        $.ajax({
	            method: "POST",
	            contentType: "application/json; charset=utf-8",
	            Accept: "application/json; charset=utf-8",
	            url: "http://localhost:8000/map/rest/getTransitRouteList", // 대중교통
	            data: JSON.stringify(requestData),

	            success: function(response) {
	                console.log(response);

	                response.forEach((path, index) => {
	                    const routeList = path.routeList;

	                    paths.push({
	                        index: index + 1,
	                        totalFare: path.totalFare,
	                        totalTime: path.totalTime,
	                        totalDistance: path.totalDistance,
	                        totalWalkTime: path.totalWalkTime,
	                        transferCount: path.transferCount,
	                        pathType: path.pathType,

	                        routes: routeList.map(route => ({
	                            mode: route.mode,
	                            routeName: route.route,
	                            startName: route.startName,
	                            startLat: route.startLat,
	                            startLon: route.startLon,
	                            endName: route.endName,
	                            endLat: route.endLat,
	                            endLon: route.endLon,
	                            lineStringLat: route.lineStringLat,
	                            lineStringLon: route.lineStringLon
	                        }))
	                    });
	                });

	                const pathListDiv = document.getElementById('path-list');

	                paths.forEach((path, index) => {
	                    const pathDiv = document.createElement('div');
	                    pathDiv.textContent = `Path ${index + 1}: Total Fare: ${path.totalFare}, Total Time: ${path.totalTime}`;
	                    pathDiv.style.cursor = 'pointer';
	                    pathDiv.addEventListener('click', () => showPathDetails(index));
	                    pathListDiv.appendChild(pathDiv);
	                });

	                function showPathDetails(index) {
	                    clearPolylines();
	                    clearMarkers();

	                    for (let i = 0; i < paths[index].routes.length; i++) {
	                        drawInfoArr = [];

	                        for (let j = 0; j < paths[index].routes[i].lineStringLat.length; j++) {
	                            const lat = paths[index].routes[i].lineStringLat[j];
	                            const lon = paths[index].routes[i].lineStringLon[j];
	                            const latlng = new kakao.maps.LatLng(lat, lon);
	                            bounds.extend(latlng);
	                            drawInfoArr.push(latlng);
	                        } // 이게 안에 있는 세부정보들

	                        setMarkers([{ latitude: paths[index].routes[i].startLat, longitude: paths[index].routes[i].startLon }]);

	                        if (paths[index].routes[i].mode == 'WALK') {
	                            drawLine(drawInfoArr, 0);
	                        } else {
	                            drawLine(drawInfoArr, 1);
	                        }

	                        map.setBounds(bounds);
	                    } // 이게 라우트 1,2,3,4,5

	                    const path = paths[index];
	                    const pathDetailsDiv = document.getElementById('path-details');
	                    pathDetailsDiv.innerHTML = `
	                        <h2>Path ${path.index}</h2>
	                        <p>Total Fare: ${path.totalFare}</p>
	                        <p>Total Time: ${path.totalTime}</p>
	                        <p>Total Distance: ${path.totalDistance}</p>
	                        <p>Total Walk Time: ${path.totalWalkTime}</p>
	                        <p>Transfer Count: ${path.transferCount}</p>
	                        <p>Path Type: ${path.pathType}</p>
	                        <h3>Routes:</h3>
	                        ${path.routes.map(route => `
	                            <div>
	                                <p>Mode: ${route.mode}</p>
	                                <p>Route: ${route.routeName}</p>
	                                <p>Start: ${route.startName} (${route.startLat}, ${route.startLon})</p>
	                                <p>End: ${route.endName} (${route.endLat}, ${route.endLon})</p>
	                                <p>Line String Latitudes: ${route.lineStringLat.join(', ')}</p>
	                                <p>Line String Longitudes: ${route.lineStringLon.join(', ')}</p>
	                            </div>
	                        `).join('')}
	                    `;
	                } // showPathDetails

	                setMarkers([
	                    { latitude: requestData.startY, longitude: requestData.startX },
	                    { latitude: requestData.endY, longitude: requestData.endX }
	                ]);

	            } // success
	        }); // ajax 대중교통
	    }).fail(function(error) {
	        console.log('위치를 불러오는데 실패', error);
	    });
	}; // 대중교통 경로찾기
	
	function getCurrentLocation() {
	    let deferred = $.Deferred();

	    if (navigator.geolocation) {
	        navigator.geolocation.getCurrentPosition(function(position) {
	            currentLatitude = position.coords.latitude;
	            currentLongitude = position.coords.longitude;

	            console.log(currentLatitude);
	            console.log(currentLongitude);

	            let locPosition = new kakao.maps.LatLng(currentLatitude, currentLongitude); // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성
	            map.setCenter(locPosition); // map center 변경

	            deferred.resolve(position);
	        }, function(error) {
	            deferred.reject(error);
	        });
	    } else {
	        deferred.reject(new Error('현재 위치를 알 수 없습니다.'));
	    }

	    return deferred.promise();
	} // getCurrentLocation: 현재 위치를 가져오는 함수

	function drawLine(arrPoint, mode) {
	    let polyline = new kakao.maps.Polyline({
	        path: arrPoint, // 선을 구성하는 좌표배열
	        strokeWeight: 7, // 선의 두께
	        strokeColor: mode === 0 ? 'black' : 'blue', // 선의 색깔
	        strokeOpacity: 1, // 선의 불투명도, 1에서 0 사이의 값이며 0에 가까울수록 투명
	        strokeStyle: mode === 0 ? 'dash' : 'solid' // 선의 스타일
	    });

	    polyline.setMap(map);
	    polylines.push(polyline); // 배열에 폴리라인 객체를 추가
	} // drawLine: 라인을 그리는 함수

	function clearPolylines() {
	    for (let i = 0; i < polylines.length; i++) {
	        polylines[i].setMap(null);
	    }

	    polylines = []; // 배열을 초기화하여 폴리라인 객체를 삭제
	} // clearPolylines: 모든 폴리라인 제거

	function setMarkers(locations) {
		bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경
		
	    locations.forEach(location => {
	        let markerPosition = new kakao.maps.LatLng(location.latitude, location.longitude);
	        let marker = new kakao.maps.Marker({
	            position: markerPosition,
	            clickable: true
	        });
	        
	        marker.setMap(map);
	        markers.push(marker);

	        bounds.extend(markerPosition);
	        map.setBounds(bounds);

	        kakao.maps.event.addListener(marker, 'click', function() {
	        	selectLatitude = location.latitude;
	    	    selectLongitude = location.longitude;
	        }); // 마커에 클릭이벤트를 등록
	    });
	} // setMarkers

	function clearMarkers() {
	    for (let i = 0; i < markers.length; i++) {
	        markers[i].setMap(null);
	    }

	    markers = []; // 배열을 초기화하여 마커 객체를 삭제
	} // clearMarkers: 모든 마커를 지도에서 제거하는 함수

</script>
	
</head>
<body>
	<div id="mapWrap" style="width: 100%; height: 100%;">
		<div id="map" style="width: 100%; height: 90%;"></div>
		<button onclick="drawRoute('1')">도보 경로 요청하기</button>
		<button onclick="drawRoute('2')">자동차 경로 요청하기</button>
		<button onclick="drawTransitRoute()">대중교통 경로 요청하기</button>
		<div id="result"></div>
		<div id="description"></div>
		<div id="path-list"></div>
		<div id="path-details"></div>
	</div>
</body>
</html>