<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>맵</title>
<style>
	html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
</style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9bb092e55e04073df199c8fdf46abadd"></script>
	
	<script th:inline="javascript">
	let map;
	let markers = [];
	let tempMarkers = [];
	let polylines = [];
	let bounds;
	let selectLatitude;
	let selectLongitude;
	let paths = [];
	
	const currentCircle = "//t1.daumcdn.net/localimg/localimages/07/2018/mw/m640/ico_marker.png";
	
	$(document).ready(function() {
		let mapContainer = document.getElementById('map'), // 지도를 표시할 div 
		mapOption = {
			center : new kakao.maps.LatLng(37.499396, 127.029038), // 지도의 중심좌표
			level : 3 // 지도의 확대 레벨
		};

		map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성
		
		$('#searchForm').on('submit', function(event) {
			event.preventDefault();
			searchRecord();
		});
		
		$('#private, #public, #follow, input[name="radius"]').on('change', function(event) {
			event.preventDefault();
			searchRecord();
		});
		
		$('#searchForm').trigger('submit');
		//getRecommendRecord();
	});// 페이지 로드 시 폼 자동 제출
	
	const searchRecord = () => {
		clearMarkers();
		clearPolylines();
		deleteHTML();
		
		getCurrentLocation().done(function(location) {

			setMarkers([{ latitude: location.coords.latitude, longitude: location.coords.longitude }], currentCircle);

			const requestData = { latitude: location.coords.latitude, 
						  longitude: location.coords.longitude, 
						  radius: $('input[name="radius"]:checked').val(), 
						  sharedType:  $('#public').is(':checked') ? 1 : 0, 
						  followType: $('#follow').is(':checked') ? 1 : 0, 
						  privateType: $('#private').is(':checked') ? 1 : 0, 
						  categoryNo: 0,
						  userId:"user1",
						  searchKeyword: $('input[name="searchKeyword"]').val() };

			$.ajax({
				//url: "http://localhost:8000/map/rest/getMapRecordList", // 요청을 보낼 URL을 입력
				url: "https://www.mapmory.co.kr/map/rest/getMapRecordList", // 요청을 보낼 URL을 입력
				contentType: 'application/json', // Content-Type을 JSON으로 설정
				method: 'POST',
				data: JSON.stringify(requestData),
				success: function(response) {
					console.log(response);

					bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경
					
					if(response.length != 0){
						const coordinates = response.map(record => {
							const latLng = new kakao.maps.LatLng(record.latitude, record.longitude);
							bounds.extend(latLng);
							
							const recordElement = `
								<div class="record-info">
			                    <h2>Record Information</h2>
			                    <p><strong>Record No:</strong> ${record.recordNo}</p>
			                    <p><strong>Record User ID:</strong> ${record.recordUserId}</p>
			                    <p><strong>Nick Name:</strong> ${record.nickName ? record.nickName : 'N/A'}</p>
			                    <p><strong>Profile Image Name:</strong> ${record.profileImageName ? record.profileImageName : 'N/A'}</p>
			                    <p><strong>Record Title:</strong> ${record.recordTitle}</p>
			                    <p><strong>Latitude:</strong> ${record.latitude}</p>
			                    <p><strong>Longitude:</strong> ${record.longitude}</p>
			                    <p><strong>Checkpoint Address:</strong> ${record.checkpointAddress}</p>
			                    <p><strong>Checkpoint Date:</strong> ${record.checkpointDate}</p>
			                    <p><strong>Media Name:</strong> ${record.mediaName}</p>
			                    <h3>Image Tags</h3>
			                    <ul>
			                    	${record.imageName ? record.imageName.map(tag => `<li>${tag.imageTagText}</li>`).join('') : '<li>No image tags available</li>'}
			                    </ul>
			                    <h3>Hashtags</h3>
			                    <ul>
			                    	${record.hashtag ? record.hashtag.map(tag => `<li>${tag.imageTagText}</li>`).join('') : '<li>No hashtags available</li>'}
			                    </ul>
			                    <p><strong>Category No:</strong> ${record.categoryNo}</p>
			                    <p><strong>Category Name:</strong> ${record.categoryName ? record.categoryName : 'N/A'}</p>
			                    <p><strong>Category Imoji:</strong> ${record.categoryImoji ? `<img src="${record.categoryImoji}" alt="Category Imoji" />` : 'N/A'}</p>
			                    <p><strong>Record Text:</strong> ${record.recordText}</p>
			                    <p><strong>Temp Type:</strong> ${record.tempType}</p>
			                    <p><strong>Record Add Date:</strong> ${record.recordAddDate}</p>
			                    <p><strong>Shared Date:</strong> ${record.sharedDate}</p>
			                    <p><strong>Update Count:</strong> ${record.updateCount}</p>
			                    <p><strong>D-Day Date:</strong> ${record.d_DayDate ? new Date(record.d_DayDate).toLocaleString() : 'N/A'}</p>
			                    <p><strong>Time Capsule Type:</strong> ${record.timecapsuleType}</p>
			                    <p><strong>Distance:</strong> ${record.distance}</p>
			                </div>
								<hr/>
						        `;
						        
						        $('#result').append(recordElement);
						        
							return {
								latitude: record.latitude,
								longitude: record.longitude,
								recordNo: record.recordNo
							};
						});
					        
						map.setBounds(bounds);
						setMarkers(coordinates);
					}else{
						alert("해당하는 기록이 없습니다!!");
					}//if~else
					
				}, // success
				error: function(error) {
					console.log('ajax 에러 발생:', error);
				} // error
			}); //기록 검색 ajax

		}).fail(function(error) {
			console.log('위치 정보를 불러오는데 실패함:', error);
		});// 위치정보 불러오기 실패
	};
	
	/* const getRecommendRecord = () => {
		clearPolylines();
		
		getCurrentLocation().done(function(location) {

			setMarkers([{ latitude: location.coords.latitude, longitude: location.coords.longitude }], currentCircle);

			const requestData = { latitude: location.coords.latitude, 
						  longitude: location.coords.longitude, 
						  radius: $('input[name="radius"]:checked').val(), 
						  sharedType:  $('#public').is(':checked') ? 1 : 0, 
						  followType: $('#follow').is(':checked') ? 1 : 0, 
						  privateType: $('#private').is(':checked') ? 1 : 0, 
						  categoryNo: 0,
						  userId:"user1",
						  searchKeyword: $('input[name="searchKeyword"]').val() };

			$.ajax({
				url: "http://localhost:8000/recommend/rest/getSearchRecommend", // 요청을 보낼 URL을 입력
				contentType: 'application/json', // Content-Type을 JSON으로 설정
				method: 'GET',
				//data: JSON.stringify(requestData),
				success: function(response) {
					console.log(response);

					bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경
					
					if(response.length != 0){
						alert("성공!!");
					}else{
						alert("해당하는 기록이 없습니다!!");
					}//if~else
					
				}, // success
				error: function(error) {
					console.log('ajax 에러 발생:', error);
				} // error
			}); //기록 검색 ajax

		}).fail(function(error) {
			console.log('위치 정보를 불러오는데 실패함:', error);
		});// 위치정보 불러오기 실패
	}; */
	
	const drawRoute = (type) => {
		const urlParameter = type == 1 ? "getPedestrianRoute" : "getCarRoute";
		deleteHTML();
		hideMarkers();
	    clearPolylines();
	    
	    getCurrentLocation().done(function(location) {

	        let tDescription; // 설명
	        let drawInfoArr = []; // 선을 그릴 위도,경도 모음

	        const requestData = {
	            startX: location.coords.longitude,
	            startY: location.coords.latitude,
	            endX: selectLongitude,
	            endY: selectLatitude,
	            reqCoordType: "WGS84GEO",
	            resCoordType: "WGS84GEO",
	            startName: "출발",
	            endName: "도착"
	        }; 

	        $.ajax({
	            method: "POST",
	            contentType: 'application/json; charset=utf-8',
	            //url: "http://localhost:8000/map/rest/" + urlParameter,
	            url: "https://www.mapmory.co.kr/map/rest/" + urlParameter,
	            data: JSON.stringify(requestData),

	            success: function(response) {
	                console.log(response);

	                setMarkers([{ latitude: requestData.startY, longitude: requestData.startX }], "//t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/blue_b.png");
	                setMarkers([{ latitude: requestData.endY, longitude: requestData.endX }], "//t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/red_b.png");

	                const tDistance = "<span>총 거리 : " + ((response.totalDistance) / 1000).toFixed(1) + "km,</span>";
	                const tTime = "<span>총 시간 : " + ((response.totalTime) / 60).toFixed(0) + "분</span>";

	                $("#result").html(tDistance + tTime);

	                bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경

	                for (let i = 0; i < response.lat.length; i++) {
	                    const latlng = new kakao.maps.LatLng(response.lat[i], response.lon[i]);
	                    bounds.extend(latlng);
	                    drawInfoArr.push(latlng);
	                }

	                let description = $('#description');
	                description.empty();
	                response.description.forEach(function(desc) {
	                    let p = $('<p></p>').text(desc);
	                    description.append(p);
	                });

	                drawLine(drawInfoArr, 1);
	                map.setBounds(bounds);
	            }, // success

	            error: function(request, status, error) {
	                console.error("에러!!");
	            } // error
	        }); // ajax
	    }).fail(function(error) {
	        console.log('Error getting location:', error);
	    });
	}; // 보행자, 자동차

	const drawTransitRoute = () => {

		deleteHTML();
		hideMarkers();
	    clearPolylines();
	    
	    getCurrentLocation().done(function(location) {

	        let tDescription; // 설명
	        let drawInfoArr = []; // 선을 그릴 위도,경도 모음
	        bounds = new kakao.maps.LatLngBounds(); // 중심좌표 변경
	        
	        const requestData = {
	            startX: location.coords.longitude,
	            startY: location.coords.latitude,
	            endX: selectLongitude,
	            endY: selectLatitude,
	            lang: "0",
	            count: "10",
	            format: "json"
	        }; // 대중교통

	        $.ajax({
	            method: "POST",
	            contentType: "application/json; charset=utf-8",
	            Accept: "application/json; charset=utf-8",
	            //url: "http://localhost:8000/map/rest/getTransitRouteList", // 대중교통
	            url: "https://www.mapmory.co.kr/map/rest/getTransitRouteList", // 대중교통
	            data: JSON.stringify(requestData),

	            success: function(response) {
	                console.log(response);

	                response.forEach((path, index) => {
	                    const routeList = path.routeList;

	                    paths.push({
	                        index: index + 1,
	                        totalFare: path.totalFare,
	                        totalTime: path.totalTime,
	                        totalDistance: path.totalDistance,
	                        totalWalkTime: path.totalWalkTime,
	                        transferCount: path.transferCount,
	                        pathType: path.pathType,

	                        routes: routeList.map(route => ({
	                            mode: route.mode,
	                            routeName: route.route,
	                            startName: route.startName,
	                            startLat: route.startLat,
	                            startLon: route.startLon,
	                            endName: route.endName,
	                            endLat: route.endLat,
	                            endLon: route.endLon,
	                            lineStringLat: route.lineStringLat,
	                            lineStringLon: route.lineStringLon
	                        }))// routes
	                    });//path.push
	                });//foreach

	                const pathListDiv = document.getElementById('path-list');

	                paths.forEach((path, index) => {
	                    const pathDiv = document.createElement('div');
	                    pathDiv.textContent = `Path ${index + 1}: Total Fare: ${path.totalFare}, Total Time: ${path.totalTime}`;
	                    pathDiv.style.cursor = 'pointer';
	                    pathDiv.addEventListener('click', () => showPathDetails(index));
	                    pathListDiv.appendChild(pathDiv);
	                });

	                function showPathDetails(index) {
	            		deleteHTML();
	                    clearPolylines();
	                    clearMarkers();

	                    for (let i = 0; i < paths[index].routes.length; i++) {
	                        drawInfoArr = [];

	                        for (let j = 0; j < paths[index].routes[i].lineStringLat.length; j++) {
	                            const lat = paths[index].routes[i].lineStringLat[j];
	                            const lon = paths[index].routes[i].lineStringLon[j];
	                            const latlng = new kakao.maps.LatLng(lat, lon);
	                            bounds.extend(latlng);
	                            drawInfoArr.push(latlng);
	                        } // 이게 안에 있는 세부정보들

	                        setMarkers([{ latitude: paths[index].routes[i].startLat, longitude: paths[index].routes[i].startLon }]);

	                        if (paths[index].routes[i].mode == 'WALK') {
	                            drawLine(drawInfoArr, 0);
	                        } else {
	                            drawLine(drawInfoArr, 1);
	                        }

	                        map.setBounds(bounds);
	                    } // 이게 라우트 1,2,3,4,5

	                    const path = paths[index];
	                    const pathDetailsDiv = document.getElementById('path-details');
	                    pathDetailsDiv.innerHTML = `
	                        <h2>Path ${path.index}</h2>
	                        <p>Total Fare: ${path.totalFare}</p>
	                        <p>Total Time: ${path.totalTime}</p>
	                        <p>Total Distance: ${path.totalDistance}</p>
	                        <p>Total Walk Time: ${path.totalWalkTime}</p>
	                        <p>Transfer Count: ${path.transferCount}</p>
	                        <p>Path Type: ${path.pathType}</p>
	                        <h3>Routes:</h3>
	                        ${path.routes.map(route => `
	                            <div>
	                                <p>Mode: ${route.mode}</p>
	                                <p>Route: ${route.routeName}</p>
	                                <p>Start: ${route.startName}</p>
	                                <p>End: ${route.endName}</p>
	                            </div>
	                        `).join('')}
	                    `;
	                } // showPathDetails
	                
	                showPathDetails(0); // 0번째 경로로 그리기
	                
	                setMarkers([
	                    { latitude: requestData.startY, longitude: requestData.startX },
	                    { latitude: requestData.endY, longitude: requestData.endX }
	                ]);

	            } // success
	        }); // ajax 대중교통
	    }).fail(function(error) {
	        console.log('위치를 불러오는데 실패', error);
	    });
	}; // 대중교통 경로찾기
	
	function getCurrentLocation() {
	    let deferred = $.Deferred();

	    if (navigator.geolocation) {
	        navigator.geolocation.getCurrentPosition(function(location) {

	            let locPosition = new kakao.maps.LatLng(location.coords.latitude, location.coords.longitude); // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성
	            map.setCenter(locPosition); // map center 변경

	            deferred.resolve(location);
	        }, function(error) {
	            deferred.reject(error);
	        });
	    } else {
	        deferred.reject(new Error('현재 위치를 알 수 없습니다.'));
	    }

	    return deferred.promise();
	} // getCurrentLocation: 현재 위치를 가져오는 함수

	function drawLine(arrPoint, mode) {
	    let polyline = new kakao.maps.Polyline({
	        path: arrPoint, // 선을 구성하는 좌표배열
	        strokeWeight: 7, // 선의 두께
	        strokeColor: mode === 0 ? 'black' : 'blue', // 0 = 걸을 때, 1 = 그 외 선 색깔
	        strokeOpacity: 1, // 선의 불투명도, 1에서 0 사이의 값이며 0에 가까울수록 투명
	        strokeStyle: mode === 0 ? 'dash' : 'solid' // 0 = 걸을 때 점선, 1 = solide 선의 스타일
	    });

	    polyline.setMap(map);
	    polylines.push(polyline); // 배열에 폴리라인 객체를 추가
	} // drawLine: 라인을 그리는 함수

	function setMarkers(coordinates, img) {
		
		coordinates.forEach(location => {
	    	
	        let markerPosition = new kakao.maps.LatLng(location.latitude, location.longitude);
	        let markerOptions = {
	                position: markerPosition,
	                clickable: true
	        };
	        
	        if (img) {
	            let icon = new kakao.maps.MarkerImage(img, new kakao.maps.Size(35, 35), {
	                offset: new kakao.maps.Point(16, 34),
	                shape: "poly",
	                coords: "1,20,1,9,5,2,10,0,21,0,27,3,30,9,30,20,17,33,14,33"
	            });
	            markerOptions.image = icon;
	            markerOptions.zIndex = 4;
	        }
	        
	        let marker = new kakao.maps.Marker(markerOptions);

	        marker.setMap(map);
	        markers.push(marker);

	        kakao.maps.event.addListener(marker, 'mouseover', function() {
	        	
	        }); // 마커에 오버이벤트를 등록
	        
	        kakao.maps.event.addListener(marker, 'click', function() {
	        	selectLatitude = location.latitude;
	    	    selectLongitude = location.longitude;
	    	    
	    	    $.ajax({
	    			//url: "http://localhost:8000/map/rest/getDetailRecord", // 요청을 보낼 URL을 입력
	    			url: "https://mapmory.co.kr/map/rest/getDetailRecord", // 요청을 보낼 URL을 입력
	    			contentType: 'application/json', // Content-Type을 JSON으로 설정
	    			method: 'POST',
	    			data: JSON.stringify({recordNo: location.recordNo}),
	    			success: function(response) {
	    				console.log(response);

	    				if(response.length != 0){
	    					deleteHTML();
	    					
	    					let html = `
	    		                <h2>Record Information</h2>
	    		                <p><strong>Record No:</strong> ${response.recordNo}</p>
	    		                <p><strong>Record User ID:</strong> ${response.recordUserId}</p>
	    		                <p><strong>Record Title:</strong> ${response.recordTitle}</p>
	    		                <p><strong>Latitude:</strong> ${response.latitude}</p>
	    		                <p><strong>Longitude:</strong> ${response.longitude}</p>
	    		                <p><strong>Checkpoint Address:</strong> ${response.checkpointAddress}</p>
	    		                <p><strong>Checkpoint Date:</strong> ${response.checkpointDate}</p>
	    		                <p><strong>Media Name:</strong> ${response.mediaName}</p>
	    		                <h3>Image Tags</h3>
	    		                <ul>
	    		                	${response.imageName.map(tag => `<li><img src="https://kr.object.ncloudstorage.com/mapmory-object/productImage/test.png" alt="${tag.imageTagText}" /></li>`).join('')}
	    		            	</ul>
	    		                <h3>Hashtags</h3>
	    		                <ul>
	    		                    ${response.hashtag.map(tag => `<li>${tag.imageTagText}</li>`).join('')}
	    		                </ul>
	    		                <p><strong>Category No:</strong> ${response.categoryNo}</p>
	    		                <p><strong>Category Name:</strong> ${response.categoryName}</p>
	    		                <p><strong>Category Imoji:</strong> <img src="@{/category/image/${response.categoryImoji} }" alt="Category Imoji" /></p>
	    		                <p><strong>Record Text:</strong> ${response.recordText}</p>
	    		                <p><strong>Temp Type:</strong> ${response.tempType}</p>
	    		                <p><strong>Record Add Date:</strong> ${response.recordAddDate}</p>
	    		                <p><strong>Shared Date:</strong> ${response.sharedDate}</p>
	    		                <p><strong>Update Count:</strong> ${response.updateCount}</p>
	    		                <p><strong>D-Day Date:</strong> ${new Date(response.d_DayDate).toLocaleString()}</p>
	    		                <p><strong>Time Capsule Type:</strong> ${response.timecapsuleType}</p>
	    		                <p><strong>Distance:</strong> ${response.distance}</p>
	    		            `;
	    		            
	    		            const resultDiv = document.getElementById('result');
	    		            resultDiv.innerHTML = html;
	    				}else{
	    					alert("해당하는 기록이 없습니다!!");
	    				}//if~else
	    				
	    			}, // success
	    			error: function(error) {
	    				console.log('ajax 에러 발생:', error);
	    			} // error
	    		}); //기록 검색 ajax
	        }); // 마커에 클릭이벤트를 등록
	        
	    });
	} // setMarkers
	
	function clearPolylines() {
	    for (let i = 0; i < polylines.length; i++) {
	        polylines[i].setMap(null);
	    }

	    polylines = []; // 배열을 초기화하여 폴리라인 객체를 삭제
	} // clearPolylines: 모든 폴리라인 제거

	function clearMarkers() {
	    for (let i = 0; i < markers.length; i++) {
	        markers[i].setMap(null);
	    }

	    markers = []; // 배열을 초기화하여 마커 객체를 삭제
	} // clearMarkers: 모든 마커를 지도에서 제거하는 함수
	
	function hideMarkers() {
/* 		markers.forEach(marker => {
			marker.setMap(null);
		});  */
		
		tempMarkers = [...markers];
		clearMarkers();
	}
	
	function showMarkers(){
		markers.forEach(marker => {
			marker.setMap(null);
		});
		
		clearMarkers();
		
		markers = [...tempMarkers];
		tempMarkers = [];
		
		markers.forEach(marker => {
			marker.setMap(map);
			bounds.extend( marker.getPosition() );
		}); 
		
		map.setBounds(bounds);
		clearPolylines();
		deleteHTML();
	}
	
	function deleteHTML(){

        const pathListDiv = document.getElementById('path-list');
        pathListDiv.innerHTML = '';
        
        const pathDetailsDiv = document.getElementById('path-details');
        pathDetailsDiv.innerHTML = '';

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        
        const descriptionDiv = document.getElementById('description');
        descriptionDiv.innerHTML = '';
	}

	
</script>
	
</head>
<body>
	<div id="mapWrap" style="width: 100%; height: 100%;">
		<div id="map" style="width: 100%; height: 90%;"></div>
		<button onclick="drawRoute('1')">도보 경로 요청하기</button>
		<button onclick="drawRoute('2')">자동차 경로 요청하기</button>
		<button onclick="drawTransitRoute()">대중교통 경로 요청하기</button>
		<button onclick="showMarkers()">경로 찾기 이전버튼</button>
		<form id="searchForm">
			<div>
            	<input type="checkbox" id="private" name="private" checked>
            	<label for="private">Private</label>
        	</div>
        	
        	<div>
            	<input type="checkbox" id="public" name="public" checked>
            	<label for="public">Public</label>
        	</div>
        	
        	<div>
            	<input type="checkbox" id="follow" name="follow" checked>
            	<label for="follow">Follow</label>
        	</div>
        	
			<input type="text" name="searchKeyword" placeholder="검색어를 입력하세요" />
        	
       		<label>
            	<input type="radio" name="radius" value="1" checked> 1km
        	</label>
        	
        	<label>
            	<input type="radio" name="radius" value="3"> 3km
        	</label>
        	
        	<label>
            	<input type="radio" name="radius" value="5"> 5km
        	</label>
		</form>
		
		<div id="result"></div>
		<div id="description"></div>
		<div id="path-list"></div>
		<div id="path-details"></div>
	</div>
</body>
</html>