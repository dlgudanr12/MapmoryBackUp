<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="UTF-8">
	<title>댓글</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>	
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	
	<!-- 댓글 작성 시작 -->
	<script type ="text/javascript">
	$(document).ready(function() {
		$('#replyForm').submit(function(event) {
			event.preventDefault();
                
			var formData = new FormData(this);
			var replyText = $('#replyText').val().trim();
			
			if(replyText === '') {
				alert('댓글 내용을 입력해주세요');
				return;
			}

			var recordNo = $('#recordNo').val();
			console.log(recordNo);
			formData.append("recordNo", recordNo);
			formData.append("userId", "user5");
            
			var reply = {
				recordNo : recordNo,
				userId : "user5",
				replyText : replyText,
				replyImageName : replyImageName
			};

			formData.append("reply", JSON.stringify(reply));
            
			$.ajax({
				type : 'POST',
				url: '/community/rest/addReply',
				enctype : 'multipart/form-data',
				contentType : false,
				processData : false,
				data : formData, 
				success : function(data) {
					console.log('댓글 작성 완료 :', data);
					updateReplyList(data);
				},
				error : function(xhr, status, error) {
					console.error('댓글 작성 실패 : ', error);
				}
			});
			
			// 댓글 목록에 새로운 댓글 추가 함수
			function updateReplyList(replyData) {

				console.log("replyData : " + JSON.stringify(replyData));
				
				var recordNo = replyData.recordNo;
				var replyNo = replyData.replyNo;
				var userId = replyData.userId;
				var nickname = replyData.nickname;
				var profileImageName = replyData.profileImageName;
				var subscriptionEndDate = replyData.subscriptionEndDate;
				var replyText = replyData.replyText;
				var replyImageName = replyData.replyImageName;
				var replyDate = replyData.replyDate;
				var likeCount = replyData.likeCount;
				var dislikeCount = replyData.dislikeCount;
				
				console.log("2. replyNo :", replyNo);
				
				// 새로운 댓글을 추가할 행을 생성
				var newRow = '<tr>' +
					'<td><a href="/user/getProfile/' + userId + '">' + nickname + '</a></td>' +
					'<td>' + profileImageName + '</td>' +
					'<td style="text-align: center;">' + subscriptionEndDate + '</td>' +
					'<td class="replyText">' + replyText + '</td>' +
					'<td>' + replyImageName + '</td>' +
					'<td>' + replyDate + '</td>' +
					'<td style="text-align: center;">' + likeCount + '</td>' +
					'<td>'+
						'<button type="button" id="likeButton">좋아요</button>'+
					'</td>'+
					'<td style="text-align: center;">' + dislikeCount + '</td>' +
					'<td>'+
						'<button type="button" id="dislikeButton">싫어요</button>'+
					'</td>'+
					'<td class="recordNo" style="display:none;">'+recordNo+'</td>'+
		            '<td class="replyNo" style="display:none;">' +replyNo +'</td>' +
		        	'<td class="userId" style="display:none;">'+userId+'</td>'+
			        '<td>' +
			            '<button type="button" class="moreBtn">더보기</button>' +
		        	'</td>' +
					'</tr>';            	
					
				console.log(newRow);	
            	                        
				// 새로운 행을 댓글 목록에 추가
				$('table tbody').append(newRow);	
				
				// 입력 필드 초기화
				$('#replyText').val('');
				$('#replyImageName').val('');
            }   
        });
    }); 
	</script>
	<!-- 댓글 작성 종료 -->
		
	<!-- 더보기 모달창 처리-->
	<script type ="text/javascript">
	var currentRow = null;
	var replyText = "";
	
	console.log(currentRow);
	
	function openModal(row) {
		currentRow = row;
		
		console.log(currentRow);
		
        var replyText = currentRow.find('.replyText').text();
        $('#replyText').val(replyText);
        
		document.getElementById("moreModal").style.display = "block";	
	}
	
	function closeModal() {
		document.getElementById("moreModal").style.display = "none";
	}
	
	function openUpdateModal() {
		if(currentRow) {
			var replyText = currentRow.find('.replyText').text();
			$('#updateReplyText').val(replyText);
		}
		document.getElementById("updateModal").style.display ="block";
	}

	function closeUpdateModal() {
		document.getElementById("updateModal").style.display ="none";
	}	
	
	
	$(function() {
		$('table').on("click", ".moreBtn", function() {
			var $row = $(this).closest('tr');
			openModal($row);
		});
		
		//댓글 수정
		$('#moreModal').on("click", "#update", function() {
			if(currentRow) {
				var replyText = currentRow.find('.replyText').text();
				$('#updateReplyText').val(replyText);
				var replyNo = currentRow.find('.replyNo').text();
				console.log("replyNo :", replyNo);
			}
			openUpdateModal();
			closeModal();

			$('#updateReplyForm').submit(function(event) {
				event.preventDefault();
	   
	        	var formData = new FormData(this);
				var updatedReplyText = $('#updateReplyText').val().trim();	        
				var recordNo = $('#recordNo').val();
				
				console.log("12 : "+recordNo);

				if(updatedReplyText === '') {
					alert('댓글 내용을 입력해주세요');
					return;
				}

				formData.append("recordNo", recordNo);
				formData.append("userId", "user5");

				var updateReply = {
					recordNo : recordNo,
					userId : userId,
					replyText : updatedReplyText,
					replyImageName : updateReplyImageName
				};

				formData.append("updateReply", JSON.stringify(updateReply));
	        
				if(currentRow) {
					var userId = "user5"
					var replyNo = currentRow.find('.replyNo').text();
					
					$.ajax({
						type : 'POST',
						url : '/community/rest/updateReply/'+replyNo,
						enctype : 'multipart/form-data',
						contentType : false,
						processData : false,
						data : formData, 
						success : function(data) {
							console.log('댓글 수정 완료 :', data);
							
							currentRow.find('.replyText').text(data	.replyText);
							
							closeUpdateModal();
						},
						error : function(xhr, status, error) {
							console.error('댓글 수정 오류');
							console.error(xhr.responseText);
						}
					});
				}
				$('#replyText').val('');
				$('#replyImageName').val('');
			});
		})
		
		//댓글 삭제
		$('#moreModal').on("click", "#delete", function() {
			
			if(currentRow) {
				var userId = "user5";
				var replyNo = currentRow.find('.replyNo').text();

				console.log(replyNo);
				
				$.ajax({
					type : 'DELETE',
					url: '/community/rest/deleteReply/'+userId+'/'+replyNo,
					success : function(data) {
						console.log('댓글 삭제 완료 :', data);
						closeModal();
						currentRow.remove();
					},
					error : function(xhr, status, error) {
						console.error('댓글 삭제 실패 : ', error);
					}
				});				
			}
			$('#replyText').val('');
			$('#replyImageName').val('');
		});	
		
		//댓글 신고
		$('#moreModal').on("click", "#addReport", function() {
			console.log(1);
			if(currentRow) {
				var userId = currentRow.find('.userId').text();
				var replyNo = currentRow.find('.replyNo').text();
				var replyText = currentRow.find('.replyText').text();
				var reportData = {
					targetUserId : userId,
					replyNo : replyNo,
					replyText : replyText
				}; 
				console.log(reportData);
				
				sessionStorage.setItem('reportData', JSON.stringify(reportData));
				
				window.location.href = '/community/addReport';
				closeModal();
			}
		});
		
		$('.close').on("click", function() {
			$('#replyText').val('');
			$('#replyImageName').val('');
			closeModal();
		});
		
		$('.close2').on("click", function() {
			$('#replyText').val('');
			$('#replyImageName').val('');
			closeUpdateModal();
		});		
		
        $(window).on("click", function(event) {
            var modal = document.getElementById("moreModal");
            if (event.target == modal) {
                closeModal();
            }		
        });
	});
	</script>
	<!-- 더보기 모달창 처리 종료 -->
	
	<!-- 댓글 좋아요 -->
	<script type="text/javascript">
	$(document).ready(function() {
		$(document).on("click", '#likeButton', function() {
			var userId = "user6"
			var row = $(this).closest('tr');
			var recordNo = row.find('.recordNo').text();
			var replyNo = row.find('.replyNo').text();
			var logsType = 2;
			var data = {
					userId : userId,
					recordNo : recordNo,
					replyNo : replyNo,
					logsType : logsType
			};
			console.log(data);
			
			$.ajax({
				type : 'POST',
				url  : '/community/rest/addCommunityLogs',
				contentType : 'application/json',
				data : JSON.stringify(data),
				success : function(response) {
					console.log('좋아요 성공');
					updateLikes(row, recordNo, replyNo, logsType);
				},
				error : function(xhr, status, error) {
					console.error('좋아요 실패');
				}
			});
			
		});
	});
	function updateLikes(row, recordNo, replyNo, logsType) {
		var data = {
			recordNo : recordNo,
			replyNo : replyNo,
			logsType : logsType
		};
		
		$.ajax({
			type : 'POST',
			url : '/community/rest/getReactionLikeTotalCount',
			contentType: 'application/json',
			data : JSON.stringify(data),
			success : function(likeCount) {
				row.find('td').eq(6).text(likeCount);
			},
			error : function(xhr, status, error) {
				console.log("데이터 가져오기 실패");
			}
		});	
	}
	</script>
	<!-- 댓글 좋아요 -->
	
	<!-- 댓글 싫어요 -->
	<script type="text/javascript">
	$(document).ready(function() {
		$(document).on("click", '#dislikeButton', function() {
			var userId = "user6"
			var row = $(this).closest('tr');
			var recordNo = row.find('.recordNo').text();
			var replyNo = row.find('.replyNo').text();
			var logsType = 3;
			var data = {
					userId : userId,
					recordNo : recordNo,
					replyNo : replyNo,
					logsType : logsType
			};
			
			$.ajax({
				type : 'POST',
				url  : '/community/rest/addCommunityLogs',
				contentType : 'application/json',
				data : JSON.stringify(data),
				success : function(response) {
					console.log('싫어요 성공');
					updateDislikes(row, recordNo, replyNo, logsType);
				},
				error : function(xhr, status, error) {
					console.error('싫어요 실패');
				}
			});
		});
	});
	
	function updateDislikes(row, recordNo, replyNo, logsType) {
		var data = {
			recordNo : recordNo,
			replyNo : replyNo,
			logsType : logsType
		};
		$.ajax({
			type : 'POST',
			url : '/community/rest/getReactionDisLikeTotalCount',
			contentType : 'application/json',
			data : JSON.stringify(data),
			success : function(dislikeCount) {
				row.find('td').eq(8).text(dislikeCount);
			},
			error : function(xhr, status, error) {
				console.log("데이터 가져오기 실패");
			}
		});			
	}
	</script>
	<!-- 댓글 싫어요 -->	
	
	<style>
		.modal {
		  display: none; /* 모달 숨기기 */
		  position: fixed;
		  z-index: 1;
		  left: 0;
		  top: 0;
		  width: 100%;
		  height: 100%;
		  overflow: auto;
		  background-color: rgb(0,0,0);
		  background-color: rgba(0,0,0,0.4);
		}
		
		.updateModal {
		  display: none; /* 모달 숨기기 */
		  position: fixed;
		  z-index: 1;
		  left: 0;
		  top: 0;
		  width: 100%;
		  height: 100%;
		  overflow: auto;
		  background-color: rgb(0,0,0);
		  background-color: rgba(0,0,0,0.4);
		}		
		
		.modal-content {
		  background-color: #fefefe;
		  margin: 15% auto;
		  padding: 20px;
		  border: 1px solid #888;
		  width: 80%;
		}
		
		.modal-content2 {
		  background-color: #fefefe;
		  margin: 15% auto;
		  padding: 20px;
		  border: 1px solid #888;
		  width: 80%;
		}		
		
		.close {
		  color: #aaa;
		  float: right;
		  font-size: 28px;
		  font-weight: bold;
		}

		.close2 {
		  color: #aaa;
		  float: right;
		  font-size: 28px;
		  font-weight: bold;
		}
		
		.close:hover,
		.close:focus {
		  color: black;
		  text-decoration: none;
		  cursor: pointer;
		}
		
		.close2:hover,
		.close2:focus {
		  color: black;
		  text-decoration: none;
		  cursor: pointer;
		}		
	</style>
	
</head>
<body>
	<h1>댓글 목록</h1>
	<table>
		<tbody>
			<tr>
				<th>닉네임</th>
				<th>프로필사진</th>
				<th>구독유무</th>
				<th>댓글내용</th>
				<th>댓글사진</th>
				<th>작성일자</th>
				<th>좋아요수</th>
				<th></th>
				<th>싫어요수</th>
				<th></th>
				<th>더보기</th>
			</tr>
			<tr th:each="reply, rowStat : ${replyList}">
				<td><a th:href="@{'/user/getProfile/' + ${reply.userId}}" th:text="${reply.nickname}"></a></td>
				<td th:text="${reply.profileImageName}"></td>
				<td th:style="'text-align: center;'" th:text="${reply.subscriptionEndDate}"></td>	
				<td class="replyText" th:text="${reply.replyText}"></td>
				<td th:text="${reply.replyImageName}"></td>
				<td th:text="${reply.replyDate}"></td>
				<td th:style="'text-align: center;'" th:text="${reply.likeCount}"></td>
				<td><button type="button" id="likeButton">좋아요</button></td>
				<td th:style="'text-align: center;'" th:text="${reply.dislikeCount}"></td>
				<td><button type="button" id="dislikeButton">싫어요</button></td>
				<td class="recordNo" style="display:none;" th:text="${reply.recordNo}" data-replyno = "${reply.recordNo}"></td>
				<td class="replyNo" style="display:none;" th:text="${reply.replyNo}" data-replyno = "${reply.replyNo}"></td>
				<td class="userId" style="display:none;" th:text="${reply.userId}" data-userid = "${reply.userId}"></td>
				<td>
				<button type="button" class="moreBtn">더보기</button>
				</td>
			</tr>
		</tbody>
	</table>
	<form id="replyForm" th:action="@{/community/rest/addReply}" method="post" enctype="multipart/form-data">	
		<label for="replyText">댓글 내용</label><br> 
		<textarea id="replyText" name="replyText" rows="4" cols="50" placeholder ="댓글을 입력하세요"></textarea><br/><br/>
		<label for="replyImageName">사진 첨부</label>
		<input type = "file" id="replyImageName" name="replyImageName" class="form-control">
		<input type="hidden" id="recordNo" name="recordNo" th:value="${recordNo}">		
		<button type ="submit" id = "add">댓글작성</button>
	</form>
		
	<div id="moreModal" class="modal">
		<div class="modal-content">
			<button type="button" id="update">수정</button>
			<button type="button" id="delete">삭제</button>
			<button type="button" id="addReport">댓글신고하기</button>
			<span class="close">&times;</span>
		</div>
	</div>

	<div id="updateModal" class="updateModal">
		<div class="modal-content2">
			<h4>댓글 수정</h4>
				<form id="updateReplyForm" th:action="@{/community/rest/addReply}" method="post" enctype="multipart/form-data">	
					<label for="updateReplyText">댓글 내용</label><br> 
					<textarea id="updateReplyText" name="updateReplyText" rows="4" cols="50" placeholder ="댓글을 입력하세요"></textarea><br/><br/>
					<label for="updateReplyImageName">사진 첨부</label>
					<input type = "file" id="updateReplyImageName" name="updateReplyImageName" class="form-control">
					<input type="hidden" id="recordNo" name="recordNo" th:value="${recordNo}">		
					<button type ="submit" id="updateBtn">댓글수정</button>
				</form>
			<span class="close2">&times;</span>
		</div>
	</div>
	<br/><br/>
<!-- 	<p th:each="reply : ${replyList}" th:text="${'댓글 내용 : ' + reply}"></p> -->
</body>	
</html>