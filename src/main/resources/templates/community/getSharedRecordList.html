<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<title>공유 기록 목록</title>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="/css/common/footer.css"> 
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>	
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.2.3/dist/cosmo/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">	

	<!-- 무한 스크롤 -->
	<script th:inline="javascript">
		var offset = 0;
		var limit = 10;
		var loading = false; 
		
		function getSharedRecordList() {
			console.log("최초 호출");
            if (loading) return; 

            loading = true;
			$.ajax({
				url : '/community/rest/getSharedRecordList',
				data : { 
						currentPage : (offset / limit ) + 1, 
						limit : limit 
				},
				success : function(data) {
					console.log("ajax 요청 시도");
					if(data.length ===0) {
						console.log("데이터 완료")	;
					} else {
						console.log("데이터 가져오기");
						offset += limit;
                        data.forEach(function(sharedRecord) {
                            var recordHtml = '<div class="card mb-3">';
                            recordHtml += '<h3 class="card-header">' + sharedRecord.recordTitle + '</h3>';
                            recordHtml += '<div class="card-body">';
                            recordHtml += '<h4>';
                            recordHtml += '<img alt="" class="profileImage" src="/user/rest/image/' + sharedRecord.profileImageName + '">';
                            recordHtml += '<a href="/user/getProfile?userId=' + sharedRecord.recordUserId + '">' + sharedRecord.nickname + '</a>';
                            recordHtml += '<span>' + sharedRecord.subscriptionEndDate + '</span>';
                            recordHtml += '</h4>';
                            recordHtml += '</div>';
                            if (sharedRecord.imageTagType != null && sharedRecord.imageTagText != null) {
                                recordHtml += '<div>';
                                recordHtml += '<svg xmlns="http://www.w3.org/2000/svg" class="d-block user-select-none" width="100%" height="200" aria-label="Placeholder: Image cap" focusable="false" role="img" preserveAspectRatio="xMidYMid slice" viewBox="0 0 318 180" style="font-size:1.125rem;text-anchor:middle">';
                                recordHtml += '<rect width="100%" height="100%" fill="#868e96"></rect>';
                                recordHtml += '<text x="50%" y="50%" fill="#dee2e6" dy=".3em">Image cap</text>';
                                recordHtml += '</svg>';
                                recordHtml += '</div>';
                            }
                            recordHtml += '<div class="card-body">';
                            recordHtml += '<i class="bi bi-chat-square-text-fill"></i>';
                            recordHtml += '<span class="reply-count">' + sharedRecord.replyCount + '</span>';
                            recordHtml += '</div>';
                            recordHtml += '<div class="card-body">';
                            recordHtml += '<h3 class="card-title">';
                            recordHtml += '<a href="/community/getDetailSharedRecord/' + sharedRecord.recordNo + '">' + sharedRecord.recordTitle + '</a>';
                            recordHtml += '<span>' + sharedRecord.categoryName + '</span>';
                            recordHtml += '<span>' + sharedRecord.categoryImoji + '</span>';
                            recordHtml += '</h3>';
                            recordHtml += '</div>';
                            recordHtml += '<div class="card-footer text-muted">';
                            recordHtml += '<span>' + sharedRecord.sharedDate + '</span>';
                            recordHtml += '<span>' + sharedRecord.updateCount + '회 수정됨</span>';
                            recordHtml += '</div>';
                            recordHtml += '</div>';

                            $('#shared-record-list').append(recordHtml);
                        });
                    }
					 loading = false;
                },
                error : function(xhr, status, error) {
                	console.error("에러발생", error);
                	loading = false;
                }
            });
        }
		
		$(document).ready(function() {
			console.log("준비 완료");
			getSharedRecordList();
			
            $(window).scroll(function() {
            	console.log("스크롤 시작");
                if ($(window).scrollTop() >= $(document).height() - $(window).height() - 100) {
                	console.log("하단 도착");
                	getSharedRecordList(); 
                }
            });
        });
	</script>

	<style>
		.reply-count {
			font-size : 18px;
			font-weight : bold;
		}
		
		.title {
			font-size : 24px;
			font-weight : solid-bold; 
		}

		.separator {
			border-top : 2px solid;
			margin-top : 20px;
		}
		
		.profileImage {
			border-radius: 50%;
			width : 50px;
			height : 50px;
		}
	</style>
		
</head>
<body>
	<div id=content-for-footer>	
		<div class="container">
			<div class="card mb-3">
				<h3 class="card-header">공유기록목록</h3>
					<div th:each="sharedRecord, iterStat  : ${sharedRecordlist}" class="col-sm-4">
						<div class="card-body">
							<h4>
								<img alt="" class="profileImage" th:src="@{/user/rest/image/{uuid}(uuid=${sharedRecord.profileImageName})}">
								<a th:href="@{/user/getProfile(userId=${sharedRecord.recordUserId})}" th:text="${sharedRecord.nickname}"></a>
								<span th:text="${sharedRecord.subscriptionEndDate}"></span>
							</h4> 
						</div>
						<div th:if="${sharedRecord.imageTagType != null and sharedRecord.imageTagText !=null}">
							<svg xmlns="http://www.w3.org/2000/svg" class="d-block user-select-none" width="100%" height="200" aria-label="Placeholder: Image cap" focusable="false" role="img" preserveAspectRatio="xMidYMid slice" viewBox="0 0 318 180" style="font-size:1.125rem;text-anchor:middle">
								<rect width="100%" height="100%" fill="#868e96"></rect>
								<text x="50%" y="50%" fill="#dee2e6" dy=".3em">Image cap</text>
							</svg>					
						</div>
						<div class="card-body">
							<i class="bi bi-chat-square-text-fill"></i>				
							<span th:text="${sharedRecord.replyCount}" class="reply-count"></span>
						</div>
						
						<div class="card-body">
							<h3 class="card-title">
								<a th:href="@{'/community/getDetailSharedRecord/' + ${sharedRecord.recordNo}}" th:text="${sharedRecord.recordTitle}" class="title"></a>
								<span th:text="${sharedRecord.categoryName}"></span>
								<span th:text="${sharedRecord.categoryImoji}"></span>
							</h3>
	
						</div>
						<div class="card-footer text-muted">
							<span th:text="${#temporals.format(sharedRecord.sharedDate, 'yyyy-MM-dd (E)')}"></span>
							<span th:text="'조회수 : ' + ${sharedRecord.logsCount}"></span>
							<span th:text="${sharedRecord.updateCount}+'회 수정됨'"></span>
						</div>
					</div>
				<div id="shared-record-list" class="container">
   				</div>	
			</div>
		</div>
	</div>
	<div th:replace="common/footer::defaultFooter"></div>	
</body>	
</html>