<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
	<meta charset="UTF-8">
	<title>결제하기</title>
	
	<script src="/javascript/config/key.js"></script>
	<script src="/javascript/purchase/purchase.js"></script>
	<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script>
      var IMP = window.IMP;
      IMP.init(API_KEYS.imp);

      function nomralRequestPay() {
    	  const selectedValue = $('input[name="paymentMethod"]:checked').val();
    	  const productTitle = $("#productTitle").val();
    	  const price = $("#price").val()
    	  const currentDate = getCurrentDate();
    	  const userId = /*[[${userId}]]*/ 'user1';
    	  
          IMP.request_pay({
              pg: selectedValue == 1 ? 'html5_inicis' : getPaymentMethod(selectedValue),
              pay_method: getPaymentMethod(selectedValue),
              merchant_uid: "purchase_"+userId+"_"+currentDate,   // 주문번호
              name: $("#productTitle").val(),
              amount: price,              // 숫자 타입
          },
          function (rsp) { // callback
            console.log(rsp);
          
          	$("#cardType").val(rsp.card_name);
          	$("#lastFourDigits").val(getLastFourDigits(rsp.card_number));
          	
          	alert("결제 성공!!");
          	
          	$("form").attr("method", "POST").attr("action", "/purchase/addPurchase/" + rsp.imp_uid).submit();
          	
          });//ajax 
      } //nomralRequestPay
      
      function monthlyRequestPay() {
    	  const currentDate = getCurrentDate();
    	  const selectedValue = $('input[name="paymentMethod"]:checked').val();
    	  const pg = getSubscriptionPG(selectedValue);
    	  
          // IMP.request_pay(param, callback) 호출
          IMP.request_pay(
            {
              pg: pg,
              merchant_uid: "billingKey_"+userId+"_"+currentDate, // 빌링키 발급용 주문번호
              customer_uid: userId, // 카드(빌링키)와 1:1로 대응하는 값
              name: "정기 구독 결제",
              amount: 0 // 0으로 설정하여 할 시 빌링키만 발급
            },//빌링키 요청

            function (rsp) {
            	console.log(rsp);
            	
            	$('input[name="userId"]').val(userId);
                $('input[name="nextSubscriptionPaymentMethod"]').val(selectedValue);
                $('input[name="nextSubscriptionCardType"]').val(rsp.card_name);
                $('input[name="nextSubscriptionLastFourDigits"]').val(getLastFourDigits(rsp.card_number));
                $('input[name="customerUid"]').val(rsp.customer_uid);
                $('input[name="merchantUid"]').val("subscription_" + userId + "_" + currentDate);
            	
                if(rsp.success){ //빌링키 발급 성공

                  	$("form").attr("method", "POST").attr("action", "/purchase/addSubscription/").submit();
    				
    			} else { //빌링키 발급 실패한 경우
    				alert('구독 결제 실패');
    			}//if~else end
    		});//callback rsp
            	
          } //monthlyRequestPay: 정기결제
		
      </script>
</head>
<body>
	
	<label for="productTitle">상품이름: </label>
	<input type="text" id="productTitle" th:field="${product.productTitle}">
	
	<label for="price">Price</label>
	<input type="number" name="price" th:field="${product.price}" readonly ><br><br>
	
	<label>Payment Method:</label><br>
	
	<div>
		<input type="radio" name="paymentMethod" value="1">
		<label for="paymentMethod">카드결제</label>
	</div>
	
	<div>
		<input type="radio" name="paymentMethod" value="2">
		<label for="paymentMethod">카카오페이</label>
	</div>
	
	<div>
		<input type="radio" name="paymentMethod" value="3">
		<label for="paymentMethod">페이코</label>
	</div>
	
	<div th:if="${product.period == 0}">
		<input type="radio" name="paymentMethod" value="4">
		<label for="paymentMethod">토스페이</label>
	</div>
	
	    	
	<div>
		<form id="subscriptionForm">
		
        	<input type="hidden" name="productNo" th:field="${product.productNo}">
        	<input type="hidden" name="cardType">
        	<input type="hidden" name="lastFourDigits" >
        	<input type="hidden" name="purchaseDate">
			<input type="hidden" name="price" th:value="${product.price}" readonly ><br><br>
		
        	<input type="hidden" name="userId" th:value="${userId}" readonly>
        	<input type="hidden" name="nextSubscriptionPaymentMethod" readonly>
        	<input type="hidden" name="nextSubscriptionCardType" readonly>
        	<input type="hidden" name="nextSubscriptionLastFourDigits" readonly>
        	<input type="hidden" name="customerUid" readonly>
        	<input type="hidden" name="merchantUid" readonly>
        	
    	</form>
    	
    	<div th:if="${product.period == 0}">
			<button onclick="nomralRequestPay()">결제하기</button>
		</div>
    	
    	<div th:if="${product.period == 30}">
			<button onclick="monthlyRequestPay()">구독결제</button>
		</div>
		
	</div>
</body>	
</html>